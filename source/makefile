

# makefile for building moe compiler on OSX, use visual studio for Windows builds
	
#BB - generate two sets of object files? ala vc?
BUILD_DIR= ./build


LLVM_BIN_PATH = ../../llvm50/cmade64/bin
#LLVM_MODULES = analysis asmparser asmprinter binaryformat codegen debuginfodwarf globalisel native target x86 core support
LLVM_MODULES = analysis asmparser binaryformat codegen globalisel x86 core 
LLVM_CFLAGS = `$(LLVM_BIN_PATH)/llvm-config --cppflags`
LLVM_LDFLAGS = `$(LLVM_BIN_PATH)/llvm-config --ldflags`
LLVM_LIBS = `$(LLVM_BIN_PATH)/llvm-config --system-libs --libs $(LLVM_MODULES)`

MISSING_LIB_PATH = /code/moe/external/MissingLlvmC/build
MISSING_LIB = libMissingLlvmC.a

CC=clang++
CFLAGS= -DPLATFORM_OSX=1 -DEWC_OSX_X64 -MMD -Wall -Werror -std=c++11 -I ../external $(LLVM_CFLAGS)
LDFLAGS=-Wl,-no_compact_unwind $(LLVM_LDFLAGS) $(LLVM_LIBS) -L $(MISSING_LIB_PATH) -lMissingLlvmC
SOURCES=CodeGen.cpp EwcString.cpp Lexer.cpp Main.cpp Parser.cpp TypeCheck.cpp UnitTest.cpp Util.cpp Workspace.cpp
OBJECTS=$(SOURCES:%.cpp=$(BUILD_DIR)/%.o)

# *.d files generated by clang (from option -MMD) so that header file edits rebuild properly
DEPENDS=$(SOURCES:%.cpp=$(BUILD_DIR)/%.d)

EXECUTABLE=moe

#targets 

release: CFLAGS += -O2
release: MAKEFLAGS = release
release: $(SOURCES) $(EXECUTABLE)

debug: CFLAGS += -DDEBUG -g
debug: MAKEFLAGS = debug
debug: $(SOURCES) $(EXECUTABLE)

#debug print target, usage example: 'make print-LLVM_CFLAGS'
print-%  : ; @echo $* = $($*)

$(EXECUTABLE): $(OBJECTS) $(MISSING_LIB_PATH)/$(MISSING_LIB)
	$(CC) $(LDFLAGS) $(OBJECTS) -o $@

$(MISSING_LIB_PATH)/$(MISSING_LIB):
	cd ../external/MissingLlvmC && $(MAKE) $(MAKEFLAGS)

%.o : ../%.cpp
	$(CC) $(CFLAGS) -c $< -o $@	

clean:
	rm -f $(BUILD_DIR)/$(EXECUTABLE) $(OBJECTS) $(DEPENDS)
	cd ../external/MissingLlvmC && $(MAKE) clean

-include $(DEPENDS)